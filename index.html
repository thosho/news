<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Reader - No API Dependency</title>
    <style>
        :root { --bg: #f0f2f5; --text: #1c1e21; --accent: #007bff; --card: #ffffff; }
        [data-theme="dark"] { --bg: #18191a; --text: #e4e6eb; --accent: #2d88ff; --card: #242526; }

        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        /* Category Tabs */
        .nav-tabs {
            position: fixed; top: 60px; width: 100%; height: 50px;
            background: var(--card); display: flex; overflow-x: auto;
            border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 900;
        }
        .tab { 
            padding: 10px 20px; white-space: nowrap; cursor: pointer; 
            border-bottom: 3px solid transparent; opacity: 0.7;
        }
        .tab.active { border-bottom-color: var(--accent); opacity: 1; font-weight: bold; }

        .header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: var(--card); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 20px; z-index: 1000;
        }

        .feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; padding-top: 110px; }
        .news-card { height: calc(100vh - 110px); scroll-snap-align: start; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .box { background: var(--card); padding: 25px; border-radius: 12px; max-width: 500px; width: 100%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .active-sentence { background: #ffeb3b; color: #000; border-radius: 4px; padding: 0 4px; }
        
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); padding: 10px 20px; border-radius: 30px;
            display: flex; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000;
        }
        .controls button { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body data-theme="light">

    <div class="header">
        <b style="font-size: 1.2rem; color: var(--accent);">NEWS READER</b>
        <button onclick="document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light')" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">üåì</button>
    </div>

    <div class="nav-tabs" id="tabs">
        <div class="tab active" onclick="loadCategory('trending', this)">Trending</div>
        <div class="tab" onclick="loadCategory('politics', this)">Politics</div>
        <div class="tab" onclick="loadCategory('sports', this)">Sports</div>
        <div class="tab" onclick="loadCategory('tech', this)">Technology</div>
    </div>

    <div class="feed" id="feed"></div>

    <div class="controls">
        <button onclick="move(-1)">‚èÆÔ∏è</button>
        <button id="p-btn" onclick="toggleAudio()">‚ñ∂Ô∏è Play</button>
        <button onclick="move(1)">‚è≠Ô∏è</button>
    </div>

    <script>
        const synth = window.speechSynthesis;
        let articles = [];
        let idx = 0;
        let isPlaying = false;

        async function loadCategory(cat, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            const res = await fetch(`/api/news?category=${cat}`);
            articles = await res.json();
            render();
        }

        function render() {
            const f = document.getElementById('feed');
            f.innerHTML = '';
            articles.forEach((a, i) => {
                const s = a.summary.split(/(?<=[.!?])\s+/).map((txt, si) => 
                    `<span class="s" id="s-${i}-${si}">${txt}</span>`).join(' ');
                f.innerHTML += `<div class="news-card" id="c-${i}"><div class="box"><h3>${a.title}</h3><p>${s}</p></div></div>`;
            });
            idx = 0;
            f.scrollTo(0,0);
        }

        function getVoice() {
            const vs = synth.getVoices();
            return vs.find(v => v.name.includes('Valluvar') || v.lang === 'ta-IN') || vs.find(v => v.lang.startsWith('ta'));
        }

        function play() {
            if (idx >= articles.length) { isPlaying = false; updateBtn(); return; }
            
            document.getElementById(`c-${idx}`).scrollIntoView({ behavior: 'smooth' });
            const utt = new SpeechSynthesisUtterance(articles[idx].summary);
            const spans = document.querySelectorAll(`#c-${idx} .s`);
            
            utt.voice = getVoice();
            utt.lang = 'ta-IN';
            utt.rate = 0.9;

            utt.onboundary = (e) => {
                let count = 0;
                spans.forEach(span => {
                    const len = span.innerText.length + 1;
                    if (e.charIndex >= count && e.charIndex < count + len) {
                        document.querySelectorAll('.s').forEach(s => s.classList.remove('active-sentence'));
                        span.classList.add('active-sentence');
                    }
                    count += len;
                });
            };

            utt.onend = () => { if (isPlaying) { idx++; setTimeout(play, 800); } };
            synth.speak(utt);
        }

        function toggleAudio() {
            if (isPlaying) { synth.cancel(); isPlaying = false; } 
            else { isPlaying = true; play(); }
            updateBtn();
        }

        function move(d) {
            synth.cancel();
            idx = Math.max(0, Math.min(articles.length - 1, idx + d));
            if (isPlaying) play();
            else document.getElementById(`c-${idx}`).scrollIntoView({ behavior: 'smooth' });
        }

        function updateBtn() { document.getElementById('p-btn').innerText = isPlaying ? "‚è∏Ô∏è Pause" : "‚ñ∂Ô∏è Play"; }

        // Initial Load
        window.speechSynthesis.onvoiceschanged = () => getVoice();
        loadCategory('trending', document.querySelector('.tab'));
    </script>
</body>
</html>
