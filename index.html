<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro News Reader</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #3b82f6;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --highlight: #fef08a;
            --active-title: #dc2626;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #60a5fa;
            --secondary: #3b82f6;
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --highlight: #ca8a04;
            --active-title: #f87171;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; transition: background 0.3s ease; }

        /* --- Header & Settings --- */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 1000;
        }
        [data-theme="dark"] .app-header { background: rgba(30, 41, 59, 0.9); border-bottom-color: rgba(255,255,255,0.05); }

        .brand { font-weight: 800; font-size: 1.25rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .header-actions button { background: none; border: none; font-size: 1.25rem; cursor: pointer; padding: 8px; border-radius: 50%; color: var(--text-main); }
        .header-actions button:hover { background: rgba(0,0,0,0.05); }

        .settings-panel {
            position: fixed; top: 60px; left: 0; right: 0;
            background: var(--surface);
            padding: 20px;
            box-shadow: var(--shadow);
            transform: translateY(-150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 990;
            display: grid; gap: 15px;
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        .settings-panel.open { transform: translateY(0); }

        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--text-sub); background: var(--bg); color: var(--text-main); font-size: 1rem; outline: none; }

        /* --- Category Tabs --- */
        .category-scroll {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;
            scrollbar-width: none;
        }
        .chip {
            padding: 8px 16px; border-radius: 20px; background: var(--bg);
            border: 1px solid var(--text-sub); color: var(--text-sub);
            font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: all 0.2s;
        }
        .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- News Feed --- */
        .feed-container {
            height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory;
            padding-top: 60px; scroll-behavior: smooth;
        }
        
        .news-card {
            height: calc(100vh - 60px); width: 100%;
            scroll-snap-align: start;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; position: relative;
        }

        .card-content {
            background: var(--surface);
            padding: 30px; border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%; max-width: 600px;
            max-height: 80vh; overflow-y: auto;
            position: relative;
        }

        .meta-tag {
            display: inline-block; padding: 4px 12px; border-radius: 12px;
            background: rgba(37, 99, 235, 0.1); color: var(--primary);
            font-size: 0.8rem; font-weight: 700; margin-bottom: 15px;
        }

        .headline { font-size: 1.5rem; font-weight: 800; line-height: 1.3; margin-bottom: 20px; color: var(--text-main); }
        .article-body { font-size: 1.15rem; line-height: 1.8; color: var(--text-sub); }

        /* --- Highlights --- */
        .hl-title { color: var(--active-title); text-decoration: underline; text-decoration-thickness: 3px; }
        .hl-sentence { background-color: var(--highlight); color: #000; border-radius: 4px; box-shadow: 0 0 0 2px var(--highlight); }

        /* --- Player Controls --- */
        .player-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            z-index: 2000;
        }
        
        .btn-control {
            background: none; border: none; color: white;
            font-size: 1.5rem; cursor: pointer; display: flex; align-items: center;
            transition: transform 0.1s;
        }
        .btn-control:active { transform: scale(0.9); }
        .btn-main { background: var(--primary); width: 50px; height: 50px; border-radius: 50%; justify-content: center; font-size: 1.2rem; }

        /* --- Utilities --- */
        .loading { text-align: center; color: var(--text-sub); font-weight: 600; }
        .hidden { display: none !important; }
    </style>
</head>
<body data-theme="light">

    <header class="app-header">
        <div class="brand">NEWS FLOW</div>
        <div class="header-actions">
            <button onclick="toggleSettings()">‚öôÔ∏è</button>
            <button onclick="toggleTheme()">üåì</button>
        </div>
    </header>

    <div class="settings-panel" id="settings">
        <div class="control-group">
            <label>Content Language</label>
            <select id="lang-select" onchange="updateFeedSource()">
                <option value="ta">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option value="en" selected>English</option>
                <option value="hi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                <option value="ml">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Category</label>
            <div class="category-scroll" id="cat-container">
                </div>
        </div>

        <div class="control-group">
            <label>Narrator Voice</label>
            <select id="voice-select"></select>
        </div>

        <div class="control-group">
            <label>Reading Speed</label>
            <select id="speed-select">
                <option value="0.8">Slow (0.8x)</option>
                <option value="1.0" selected>Normal (1.0x)</option>
                <option value="1.2">Fast (1.2x)</option>
            </select>
        </div>
        
        <button onclick="toggleSettings()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold; margin-top:10px;">Close & Apply</button>
    </div>

    <div class="feed-container" id="feed">
        <div class="news-card">
            <div class="card-content">
                <div class="loading">Initializing News Engine...</div>
            </div>
        </div>
    </div>

    <div class="player-bar">
        <button class="btn-control" onclick="navigate(-1)">‚èÆ</button>
        <button class="btn-control btn-main" id="play-btn" onclick="togglePlay()">‚ñ∂</button>
        <button class="btn-control" onclick="navigate(1)">‚è≠</button>
    </div>

    <script>
        // --- 1. Configuration & Data ---
        const RSS_SOURCES = {
            'ta': {
                'Trending': 'https://www.dailythanthi.com/rss/News/TopNews',
                'Cinema': 'https://www.dailythanthi.com/rss/Cinema/CinemaNews',
                'World': 'https://www.dinamalar.com/rss_section.asp?id=12',
                'Spritual': 'https://www.dailythanthi.com/rss/Spiritual/General'
            },
            'en': {
                'Top Stories': 'http://feeds.bbci.co.uk/news/rss.xml',
                'Tech': 'http://feeds.bbci.co.uk/news/technology/rss.xml',
                'India': 'https://timesofindia.indiatimes.com/rssfeeds/296589292.cms',
                'Business': 'http://feeds.bbci.co.uk/news/business/rss.xml'
            },
            'hi': {
                'Top News': 'https://www.jagran.com/rss/news-hindi.xml',
                'Cricket': 'https://www.jagran.com/rss/cricket-hindi.xml'
            },
            'ml': {
                'Latest': 'https://www.mathrubhumi.com/api/rss/latest/rss.xml',
                'Kerala': 'https://www.mathrubhumi.com/api/rss/kerala/rss.xml'
            }
        };

        const synth = window.speechSynthesis;
        let articles = [];
        let currentIndex = 0;
        let isPlaying = false;
        let currentUtterance = null;
        let selectedCategory = '';

        // --- 2. Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            populateVoices();
            updateFeedSource(); // Loads default English feed
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoices;
            }
        });

        function toggleSettings() {
            document.getElementById('settings').classList.toggle('open');
        }

        function toggleTheme() {
            const body = document.body;
            const newState = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newState);
        }

        // --- 3. Feed Management ---
        function updateFeedSource() {
            const lang = document.getElementById('lang-select').value;
            const categories = RSS_SOURCES[lang];
            const catContainer = document.getElementById('cat-container');
            
            // Rebuild Category Chips
            catContainer.innerHTML = '';
            let first = true;
            for (const [name, url] of Object.entries(categories)) {
                const chip = document.createElement('div');
                chip.className = `chip ${first ? 'active' : ''}`;
                chip.innerText = name;
                chip.onclick = () => {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    loadRSS(url, lang);
                };
                catContainer.appendChild(chip);
                if (first) { loadRSS(url, lang); first = false; }
            }
        }

        async function loadRSS(url, lang) {
            const feedContainer = document.getElementById('feed');
            feedContainer.innerHTML = '<div class="news-card"><div class="card-content"><div class="loading">Fetching & Processing News...</div></div></div>';
            
            // Use rss2json to bypass CORS
            const proxy = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
            
            try {
                const res = await fetch(proxy);
                const data = await res.json();
                
                if (data.status !== 'ok') throw new Error('Feed error');
                
                articles = data.items;
                renderCards(lang);
            } catch (e) {
                feedContainer.innerHTML = `<div class="news-card"><div class="card-content">Error loading feed. Try another category.</div></div>`;
            }
        }

        // --- 4. Rendering & Translation ---
        async function renderCards(targetLang) {
            const feedContainer = document.getElementById('feed');
            feedContainer.innerHTML = '';

            // We render cards mostly empty first, text is injected.
            // Note: Translating ALL items at once hits API limits. 
            // We will translate lazily or assume source is already correct lang.
            
            articles.forEach((item, idx) => {
                // Clean HTML tags
                const cleanDesc = (item.description || item.content || "").replace(/<[^>]*>?/gm, '');
                
                // Pre-split sentences (naive split)
                const sentences = cleanDesc.split(/(?<=[.!?‡•§])\s+/); 
                const sentenceHTML = sentences.map((s, i) => `<span class="s" id="s-${idx}-${i}">${s}</span>`).join(' ');

                const card = document.createElement('div');
                card.className = 'news-card';
                card.id = `card-${idx}`;
                card.innerHTML = `
                    <div class="card-content">
                        <div class="meta-tag">NEWS ITEM ${idx + 1}</div>
                        <div class="headline" id="h-${idx}">${item.title}</div>
                        <div class="article-body" id="b-${idx}">${sentenceHTML}</div>
                    </div>
                `;
                feedContainer.appendChild(card);
            });
            currentIndex = 0;
        }

        // --- 5. Translation Utility (Google GTX Free) ---
        async function translateText(text, targetLang) {
            // If text is already likely in target lang (simple check), skip
            // Realistically, for this demo, we assume the user selected a feed IN that language.
            // But if we MUST translate (e.g. English feed to Tamil), we use this:
            
            const sourceLang = 'auto'; 
            if (targetLang === 'en' && /[a-zA-Z]/.test(text)) return text; // Skip if english requested and text is english

            try {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(url);
                const data = await res.json();
                // Combine translated segments
                return data[0].map(x => x[0]).join('');
            } catch (e) {
                console.warn("Translation failed, using original", e);
                return text;
            }
        }

        // --- 6. TTS & Highlighting Logic ---
        function populateVoices() {
            const voices = synth.getVoices();
            const select = document.getElementById('voice-select');
            select.innerHTML = '';
            
            // Prioritize higher quality voices
            const sortedVoices = voices.sort((a, b) => {
                if (a.name.includes('Google') || a.name.includes('Natural')) return -1;
                return 1;
            });

            sortedVoices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.innerText = `${v.name} (${v.lang})`;
                select.appendChild(opt);
            });
            
            // Smart select based on current language
            const currentLang = document.getElementById('lang-select').value;
            const bestVoice = voices.find(v => v.lang.startsWith(currentLang) && (v.name.includes('Valluvar') || v.name.includes('Google')));
            if(bestVoice) select.value = bestVoice.name;
        }

        async function playStory() {
            if (currentIndex >= articles.length) { isPlaying = false; updateBtn(); return; }

            // 1. Scroll to card
            document.getElementById(`card-${currentIndex}`).scrollIntoView({ behavior: 'smooth' });

            // 2. Prepare Text
            // Check if we need translation based on UI settings vs Feed
            const uiLang = document.getElementById('lang-select').value;
            let title = articles[currentIndex].title;
            let body = document.getElementById(`b-${currentIndex}`).innerText;

            // Optional: You could enable auto-translate here if feed language mismatches UI language
            // For now, we assume the feed matches the selection for speed.

            const fullText = `${title}. . . ${body}`;

            // 3. Configure TTS
            if (currentUtterance) synth.cancel();
            currentUtterance = new SpeechSynthesisUtterance(fullText);
            
            const selectedVoiceName = document.getElementById('voice-select').value;
            const speed = parseFloat(document.getElementById('speed-select').value);
            
            const voice = synth.getVoices().find(v => v.name === selectedVoiceName);
            if (voice) currentUtterance.voice = voice;
            currentUtterance.rate = speed;
            currentUtterance.pitch = 1;

            // 4. Highlighting Logic
            const titleEl = document.getElementById(`h-${currentIndex}`);
            const sentences = document.querySelectorAll(`#card-${currentIndex} .s`);

            currentUtterance.onstart = () => { titleEl.classList.add('hl-title'); };

            currentUtterance.onboundary = (e) => {
                // Approximate boundary check
                const isTitle = e.charIndex < (title.length + 5);
                
                if (isTitle) {
                    titleEl.classList.add('hl-title');
                } else {
                    titleEl.classList.remove('hl-title');
                    
                    // Sentence Highlighting
                    // We need to map charIndex to the correct span. 
                    // This is complex because "fullText" includes the title, but spans are only body.
                    // We subtract title length to find body offset.
                    const bodyOffset = e.charIndex - (title.length + 5); 
                    
                    let runningCount = 0;
                    sentences.forEach(span => {
                        const len = span.innerText.length + 1; // +1 for space
                        if (bodyOffset >= runningCount && bodyOffset < runningCount + len) {
                            document.querySelectorAll('.s').forEach(s => s.classList.remove('hl-sentence'));
                            span.classList.add('hl-sentence');
                        }
                        runningCount += len;
                    });
                }
            };

            currentUtterance.onend = () => {
                titleEl.classList.remove('hl-title');
                document.querySelectorAll('.s').forEach(s => s.classList.remove('hl-sentence'));
                
                if (isPlaying) {
                    currentIndex++;
                    setTimeout(playStory, 1000); // Natural pause
                }
            };

            synth.speak(currentUtterance);
        }

        // --- 7. Controls ---
        function togglePlay() {
            if (isPlaying) {
                synth.cancel();
                isPlaying = false;
            } else {
                if (synth.paused) {
                    synth.resume();
                } else {
                    playStory();
                }
                isPlaying = true;
            }
            updateBtn();
        }

        function navigate(dir) {
            synth.cancel();
            currentIndex = Math.max(0, Math.min(articles.length - 1, currentIndex + dir));
            if (isPlaying) playStory();
            else document.getElementById(`card-${currentIndex}`).scrollIntoView({ behavior: 'smooth' });
        }

        function updateBtn() {
            const btn = document.getElementById('play-btn');
            btn.innerHTML = isPlaying ? "‚è∏" : "‚ñ∂";
        }

    </script>
</body>
</html>
